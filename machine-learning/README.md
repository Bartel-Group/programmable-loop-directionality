# Machine learning of microkinetic data

--------------------

Overview of the data
--------------------

This folder includes scripts and data files used to train and evaluate machine learning models on the microkinetic data generated from the loop simulation. The `ml_env.yml` file is included such that anyone may recreate the environment used to generate the machine learning results. Rate constant models and grid searches are provided, though not thoroughly dicussed in the manuscript. Further analysis of the rate constant (`rc`) models is possible by including the `rc` model_tag in the main function of the analysis scripts. Finally, the .py files in `scripts` are meant to be run in the order they are numbered (i.e. one may run any of the scripts beginning in `3-` after running `1-` and `2-`, but should not run `3-` before all of `1-` and `2-`).

*NOTE*: The Github version of this repository does *not* contain the grid search results of the RF models due to the large file size. The grid search results of the RF models can be found through UMN's DRUM repository (found here - <https://hdl.handle.net/11299/268118>).


--------------------------

SHARING/ACCESS INFORMATION
--------------------------

Terms of Use: Data Repository for the U of Minnesota (DRUM) By using these files, users agree to the Terms of Use. <https://conservancy.umn.edu/pages/drum/policies/#terms-of-use>

---------------------

SUBFOLDER/FILE OVERVIEW
---------------------

   Feature importance results: Contains the .csvs of each counterfactual prediction as well as .pkls for SHAP and permutation feature importance results for the RF and XGB architectures. For the counterfacutual files, the numbers represent the perturbation of the input parameters that result in a successful change of label. The counterfactuals are generated by the `2.5-generate-counterfactual-data.py` script. The permutation feature importance and SHAP files are generated by the `3-feature-importance.py` and `3-shap-importance.py` scripts, respectively.

         A. Filename: {model_architecture}-counterfactual-perturbations-0-to-1.csv
            Description: Counterfactuals for the change from 0 (zero TOF) to 1 (positive TOF) in the label. The numbers represent the perturbation of the input parameters that result in a successful change of label.
         
         B. Filename: {model_architecture}-counterfactual-perturbations-1-to-2.csv
            Description: Counterfactuals for the change from 1 (positive TOF) to 2 (negative TOF) in the label. The numbers represent the perturbation of the input parameters that result in a successful change of label.

         C. Filename: {model_architecture}-counterfactual-perturbations-2-to-1.csv
            Description: Counterfactuals for the change from 2 (negative TOF) to 1 (positive TOF) in the label. The numbers represent the perturbation of the input parameters that result in a successful change of label.

         D. Filename: {model_architecture}-pfi-op-clf.pkl
            Description: Permutation feature importance results for the original parameter classification model of the given architecture. The results are generated by the `3-feature-importance.py` script.

         E. Filename: {model_architecture}-pfi-op-reg.pkl
            Description: Permutation feature importance results for the original parameter regression model of the given architecture. The results are generated by the `3-feature-importance.py` script.

         F. Filename: {model_architecture}-shap_values-op-clf.pkl
            Description: SHAP values for the original parameter classification model of the given architecture. The results are generated by the `3-shap-importance.py` script. These results take a long time to generate and are saved as a .pkl file for future use. They can be reproduced or loaded directly using the `3-shap-importance.py` script.

         G. Filename: {model_architecture}-shap_values-op-reg.pkl
            Description: SHAP values for the original parameter regression model of the given architecture. The results are generated by the `3-shap-importance.py` script. These results take a long time to generate and are saved as a .pkl file for future use. They can be reproduced or loaded directly using the `3-shap-importance.py` script.

   \
   Grid search results: Contains the .pkl files of the grid search results and best estimators for each unique combination of model architecture (rf, xgb, svm/sgd), type (clf, reg), and dataset (original, rate constant). The grid search results are generated by the `2-{model_architecture}_{type}_random-cv.py` scripts.

   *NOTE*: The Github version of this repository does *not* contain the grid search results of the RF models due to the large file size. The grid search results of the RF models can be found at UMN's DRUM repository. Please see the link provided in the manuscript for access to the full dataset. The folders containing the RF models are still described below for reference.

         A. DRUM Folder: labeled-rf-models
            Description: Contains the best estimator and full grid search results for the OP random forest models trained with feature labels. These are necessary for the counterfactual (DICE) analysis. This folder can be found in the DRUM repository and should be moved to `programmable-loop-directionality/machine-learning/grid-search-results/labeled-rf-models`.

         B. DRUM Folder: rf-clf-models
            Description: Contains the best estimator and full grid search results for the random forest classification models. This folder can be found in the DRUM repository. The .pkls should be directly added to the `machine-learning/grid-search-results` folder.

         C. DRUM Folder: rf-reg-models
            Description: Contains the best estimator and full grid search results for the random forest regression models. This folder can be found in the DRUM repository. The .pkls should be directly added to the `machine-learning/grid-search-results` folder.

         D. Filename: {model_architecture}_{type}_{dataset}-best-estm.pkl
            Description: The best estimator for each unique combination of model architecture (rf, xgb, svm/sgd), type (clf, reg), and dataset (original, rate constant) from the grid search results.

         E. Filename: {model_architecture}_{type}_{dataset}.pkl
            Description: The full grid search results object for each unique combination of model architecture (rf, xgb, svm/sgd), type (clf, reg), and dataset (original, rate constant).
   \
   Scripts: Contains the .py files used to generate the machine learning results. The scripts are meant to be run in the order they are numbered, where any script beginning in the same number may be run in any order.

         A. Filename: 1-preprocess-splits.py
            Description: Preprocesses the final loop simulation data by separating steady and transient states as well as adjusting any |TOF| < 1e-4 to 0 (see manuscript for explanation). The training data is saved as `ml_data_op_steady.csv` and `ml_data_rc_steady.csv`.

         B. Filename: 1.5-data-visulization.py
            Description: Used to visualize the distribution of the turnover frequency across the full dataset. (Generates figures 2 and 3 in the manuscript)

         C. Filename: 2-response-surface-fitting.py
            Description: Used to fit the second order response surface models for the original parameters and rate constants. Also computes the regression metrics for the response surface models. These models are extremely fast to generate and are thus not saved as .pkl files.

         C. Filename: 2-{model_architecture}_clf_random-cv.py
            Description: Trains and saves both the original parameter and rate constant classification models for the given architecture using a random grid search. The best estimator and full grid search results are saved in `machine-learning/grid-search-results`.

         D. Filename: 2-{model_architecture}_reg_random-cv.py
            Description: Trains and saves both the original parameter and rate constant regression models for the given architecture using a random grid search. The best estimator and full grid search results are saved in `machine-learning/grid-search-results`.

         E. Filename: 2.5-generate-counterfactual-data.py
            Description: Used to generate the counterfactual data for the best estimators. The counterfactuals are saved in `machine-learning/counterfactual-results`. See manuscript for additional information about which counterfactuals are generated.

         F. Filename: 3-check-model-errors.py
            Description: Used to check the errors of the best estimators for each unique combination of model architecture (rf, xgb, svm/sgd), type (clf, reg) and dataset (original, rate constant) from the grid search results. This script will print the metrics that are reported in the manuscript as well as baseline metrics. This is also used to generate the hexbin parity plots (figure 6 of the manuscript).
         
         G. Filename: 3-feature-importance.py
            Description: Used to generate the feature importance plots for the best estimators and perform permutation feature importance. This also generates the feature importance plots for figures 4 and 7 of the manuscript.
         
         H. Filename: 3-plot-counterfactuals.py
            Description: Used to plot the counterfactuals generated by the `2.5-generate-counterfactual-data.py` script. This script computes the normalized mean perturbation of each feature and produces figure 5 of the manuscript.

         I. Filename: 3-shap-importance.py
            Description: Used to generate the SHAP importance data and plots for the best estimators. The SHAP importance plots are found in figures 4 and 7 of the manuscript.

   \
   Training data: Contains the .csv files of the training data used to train the machine learning models. The training data is generated by the `1-preprocess-splits.py` script.

         A. Filename: ml_data_op_steady.csv
            Description: Data used to train all original parameter models, further class labeling and seperation into training and testing data is done in the respective training scripts.
         
         B. Filename: ml_data_rc_steady.csv
            Description: Data used to train all rate constant models, further class labeling and seperation into training and testing data is done in the respective training scripts.
